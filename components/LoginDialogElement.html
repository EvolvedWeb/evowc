<component tag="login-dialog"
  :forgot-pw-href
  :sign-in-href
  :sign-in-method="str:post"
  :sign-up-href
  :busy="bool:false"
  :show-remember-me="bool:false"
  :error-message
  :#username
  :#password
  :#token
  :#remember-me="bool:false"
  :#password-type="str:password"
  :#toggle-state="str:var:STATE_SHOW"
>
  <template>
    <wc-dialog js="dialog" title="Sign in" show-footer="false" show-x="false" allow-esc="false">
      <section>
        <form :action="signInHref" :method="signInMethod|#toLower" .submit="#login">
          <input type="hidden" name="token" :value="#token" />
          <div class="error-message" $if="errorMessage" :text="errorMessage" .click="#clearError"></div>
          <div>
            <label for="username">Email:</label>
            <input id="username" name="username" :value="#username" type="email" required autocomplete="username" autofocus aria-label="Username" .input="#clearError" />
          </div>
          <div>
            <div class="password-block">
              <label for="password">Password:</label>
              <a class="forgot-pw" $if="forgotPwHref" :href="forgotPwHref" .click="#forgotPw">Forgot password?</a>
            </div>
            <input id="password" name="password" maxlength="32" :value="#password" :type="#passwordType" required autocomplete="current-password" aria-label="Password" .input="#clearError" />
            <button class="show-pw" type="button" is="wc-button" small variant="link" .click="#toggle" :attr.aria-label="#toggleState" :text="#toggleState"></button>
          </div>
            <div class="remember-me" $if="showRememberMe">
              <label><input type="checkbox" value="1" :checked="#rememberMe" .input="#rememberMeHandler"/> Remember Me</label>
            </div>
          <button class="sign-in" is="wc-button" variant="success" large aria-label="Sign in">Sign in</button>
        </form>
        <div class="sign-up" $if="signUpHref">Not a member yet? <a :href="signUpHref" .click="#signUp">Sign Up</a></div>
      </section>
      <div class="spinner-holder" $if="busy"><div class="spinner"></div></div>
    </wc-dialog>
  </template>
  <style>
    :host {
      --login-dialog-text-color: #334;
      --login-dialog-link-color: #33A;
      --login-dialog-font-size: 18px;
      color:var(--login-dialog-text-color);
      font-size: var(--login-dialog-font-size);
      height: 0;
      margin: 0;
      padding: 0;
      width: 0;
    }
    :host([size=small]) {
      --login-dialog-font-size: 14px;
    }
    :host([size=large]) {
      --login-dialog-font-size: 24px;
    }
    label, input, button {
      font: 1em Calibri, Candara, Segoe, Segoe UI, Optima, Arial, sans-serif;
    }
    wc-dialog {
      --dialog-border: 2px solid #3335;
      --dialog-border-radius: 5px;
      --dialog-header-bgcolor: #fff;
      --dialog-header-font: bold 1.6em Calibri, Candara, Segoe, Segoe UI, Optima, Arial, sans-serif;
      --dialog-header-justify: center;
      position: relative;
    }
    section {
      margin: 0;
      padding: 8px;
      width: 20em;
    }
    form {
      margin: 0;
      padding: 0;
    }
    input[type=text], input[type=email], input[type=password] {
      border-width: 1px;
      box-sizing: border-box;
      display: block;
      margin: 4px 0;
      padding: 10px 8px;
      width: 100%;
    }
    div {
      position: relative;
    }
    button.sign-in {
      margin-top: 16px;
      width: 100%;
    }
    button.show-pw {
      color:var(--login-dialog-link-color);
      position: absolute;
      bottom: 13px;
      right: 7px;
    }
    .password-block {
      align-items:baseline;
      display: flex;
      justify-content: space-between;
      margin-top: 12px;
    }
    .forgot-pw {
      font-size: clamp(10px, .75em, 16px);
      margin: 0;
      padding: 0;
    }
    .sign-up {
      font-size:  clamp(9px, .61em, 14px);
      margin-top: 12px;
      text-align: center;
    }
    .error-message {
      background-color: #F99;
      border: 1px solid #E66;
      margin-bottom: 12px;
      padding: 6px;
      text-align: center;
    }
    a {
      color:var(--login-dialog-link-color);
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    .spinner-holder {
      align-items: center;
      background-color: #3335;
      display:flex;
      justify-content: center;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }
    .spinner {
      animation: spinnerRotate 1s steps(12, end) infinite;
      background-image: url("data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 16 16'>%3Cpath d='M8.938 1.125L8.5 4c-.042.276-.3.466-.576.424C7.7 4.39 7.534 4.214 7.5 4l-.438-2.875c-.08-.518.277-1 .795-1.08.518-.08 1 .277 1.08.795.015.095.014.194 0 .285z'/>%3Cpath d='M5.375 1.577l1.06 2.708c.1.26-.028.553-.288.655-.212.083-.445.014-.58-.154L3.75 2.516c-.327-.41-.26-1.007.15-1.334.408-.328 1.005-.26 1.332.148.06.076.108.162.143.247z' opacity='.91'/>%3Cpath d='M2.515 3.75l2.27 1.816c.22.175.254.493.08.71-.142.18-.38.235-.58.157l-2.708-1.06c-.488-.19-.728-.74-.538-1.227.19-.488.74-.73 1.228-.54.09.037.175.087.247.144z' opacity='.82'/>%3Cpath d='M1.124 7.062L4 7.5c.275.042.465.3.423.576-.034.224-.21.39-.424.424l-2.876.437c-.518.08-1-.277-1.08-.795-.08-.518.277-1 .795-1.08.094-.015.193-.013.284 0z' opacity='.73'/>%3Cpath d='M1.576 10.625l2.71-1.06c.26-.1.553.028.654.288.083.21.013.444-.155.58l-2.27 1.817c-.41.327-1.007.26-1.334-.148s-.26-1.006.15-1.333c.075-.062.16-.11.246-.145z' opacity='.64'/>%3Cpath d='M3.75 13.485l1.816-2.27c.175-.22.493-.254.71-.08.178.142.234.378.156.58l-1.06 2.707c-.19.488-.74.73-1.228.538-.488-.19-.73-.74-.538-1.23.036-.087.086-.172.144-.245z' opacity='.55'/>%3Cpath d='M7.062 14.875L7.5 12c.04-.276.3-.466.575-.424.224.035.39.212.424.424l.437 2.875c.08.518-.277 1-.795 1.08-.518.08-1-.277-1.08-.795-.015-.095-.014-.194 0-.285z' opacity='.45'/>%3Cpath d='M10.625 14.423l-1.06-2.708c-.1-.26.028-.553.288-.655.21-.083.444-.013.58.155l1.815 2.27c.327.41.26 1.007-.148 1.334-.41.326-1.006.26-1.333-.15-.06-.075-.108-.16-.142-.247z' opacity='.36'/>%3Cpath d='M13.484 12.25l-2.27-1.816c-.22-.174-.254-.493-.08-.71.142-.178.378-.234.58-.156l2.708 1.06c.488.19.73.74.538 1.228s-.74.73-1.23.538c-.088-.036-.173-.086-.246-.144z' opacity='.27'/>%3Cpath d='M14.875 8.938L12 8.5c-.276-.04-.466-.3-.424-.575.034-.224.21-.39.424-.424l2.875-.437c.518-.08 1 .277 1.08.794.08.518-.277 1-.794 1.08-.095.016-.194.015-.285 0z' opacity='.18'/>%3Cpath d='M14.423 5.375l-2.708 1.06c-.26.1-.553-.028-.655-.288-.083-.21-.013-.444.155-.58l2.27-1.816c.41-.326 1.006-.26 1.334.15.327.408.26 1.005-.15 1.332-.075.06-.162.11-.247.143z' opacity='.09'/>%3C/svg>");
      background-size: cover;
      display: inline-block;
      height:64px;
      width:64px;
    }

    @keyframes spinnerRotate {
      0% {
        transform: rotateZ(0deg);
      }
      100% {
        transform: rotateZ(360deg);
      }
    }

  </style>
  <import>
    import { DIALOG_BUTTONS } from './WcDialogElement.js';

    const STATE_HIDE = 'hide';
    const STATE_SHOW = 'show';
  </import>
  <script>
    update(field, oldVal, newVal) {
      console.log('login-dialog:', this.id, field, oldVal, newVal);
    }

    open() {
      this.#username = '';
      this.#password = '';
      this.#rememberMe = false;
      setTimeout(() => {
        this.#getToken();
      }, 1);
      return this.#els.dialog.open();
    }

    #toLower(str) {
      return str.toLowerCase();
    }
    #rememberMeHandler(event) {
      this.#rememberMe = event.target.checked;
    }
    #toggle(event) {
      if (this.#toggleState === STATE_HIDE) {
        this.#toggleState = STATE_SHOW;
        this.#passwordType = 'password';
      }
      else {
        this.#toggleState = STATE_HIDE;
        this.#passwordType = 'text';
      }
    }

    #clearError() {
      if (this.errorMessage) {
        this.errorMessage = '';
      }
    }

    //******************************************
    // Events
    #dispatch(name, {
      detail = null,
      bubbles = false,
      cancelable = true,
      composed = false
    } = {}) {
      if (typeof name !== 'string' || name.length === 0) {
        throw new TypeError('name must be defined');
      }

      const event = new CustomEvent(name, { detail, bubbles, cancelable, composed });
      this.dispatchEvent(event);
      return event;
    }
    #getToken() {
      const getTokenEvent = this.#dispatch('gettoken', {
        detail: { token: '' },
        cancelable: false
      });
      this.#token = '' + getTokenEvent.detail.token || '';
    }
    #forgotPw(event) {
      const forgotPwEvent = this.#dispatch('forgotpw');
      if (forgotPwEvent.defaultPrevented) {
        event.preventDefault();
      }
    }
    #signUp(event) {
      const signUpEvent = this.#dispatch('signup');
      if (signUpEvent.defaultPrevented) {
        event.preventDefault();
      }
    }
    #login(event) {
      const data  = {
        username: this.#username,
        password: this.#password,
      };

      if (this.#showRememberMe) {
        data.rememberMe = this.#rememberMe;
      }
      if(this.#token) {
        data.token = this.#token;
      }

      console.log(data);
      const signInEvent = this.#dispatch('signin', {detail: data});
      if (signInEvent.defaultPrevented) {
        event.preventDefault();
        return;
      }

      if (!this.signInHref) {
        this.#els.dialog.closeDialog(DIALOG_BUTTONS.OK);
        event.preventDefault();
        return;
      }
    }
  </script>
</component>
